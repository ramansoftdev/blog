{% extends "layout.html" %}
{% block content %}
  <article class="border-2 border-gray-600 px-2 py-2">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-2xl font-bold mb-2"> {{ post.title }}</h2>
      <h3 class="text-sm text-gray-500">{{ post.date_posted.strftime('%B %d, %Y') }}</h3>
    </div>
    <p class="text-base mb-4"> {{ post.content }}</p>
    <div class="flex gap-3 mt-4">
      <button id="edit-post-btn" class="px-4 py-1.5 rounded bg-blue-500 dark:bg-blue-600 text-white text-sm font-medium cursor-pointer hover:bg-blue-600 dark:hover:bg-blue-500 border-2 border-transparent hover:border-blue-700 dark:hover:border-blue-300">Edit</button>
      <button id="delete-post-btn" class="px-4 py-1.5 rounded bg-red-500 dark:bg-red-600 text-white text-sm font-medium cursor-pointer hover:bg-red-600 dark:hover:bg-red-500 border-2 border-transparent hover:border-red-700 dark:hover:border-red-300">Delete</button>
    </div>
  </article>

  <!-- Edit Post Modal -->
  <div id="edit-post-modal" class="hidden">
    <div id="edit-post-modal-backdrop" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center">
      <div id="edit-post-modal-card" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Edit Post</h2>
        <form id="edit-post-form" class="space-y-3">
          <div>
            <label for="edit-post-title" class="block mb-1">Title</label>
            <input id="edit-post-title" type="text" required value="{{ post.title }}" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded px-2 py-1">
          </div>
          <div>
            <label for="edit-post-content" class="block mb-1">Your Post</label>
            <textarea id="edit-post-content" required rows="4" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded px-2 py-1">{{ post.content }}</textarea>
          </div>
          <p data-error class="text-red-500 text-sm hidden"></p>
          <div class="flex justify-end gap-2 mt-4">
            <button id="edit-post-modal-cancel" type="button" class="px-4 py-1.5 rounded border border-gray-300 dark:border-gray-500 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-1.5 rounded bg-blue-500 dark:bg-blue-600 text-white cursor-pointer hover:bg-blue-600 dark:hover:bg-blue-500 font-medium">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Post Confirmation Modal -->
  <div id="delete-post-modal" class="hidden">
    <div id="delete-post-modal-backdrop" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center">
      <div id="delete-post-modal-card" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl p-6 w-full max-w-sm">
        <h2 class="text-xl font-bold mb-2 text-red-600 dark:text-red-400">Delete Post</h2>
        <p class="mb-4 text-gray-600 dark:text-gray-300">Are you sure you want to delete this post? This action cannot be undone.</p>
        <p data-error class="text-red-500 text-sm hidden"></p>
        <div class="flex justify-end gap-2 mt-4">
          <button id="delete-post-modal-cancel" type="button" class="px-4 py-1.5 rounded border border-gray-300 dark:border-gray-500 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">Cancel</button>
          <button id="delete-post-confirm" type="button" class="px-4 py-1.5 rounded bg-red-500 dark:bg-red-600 text-white cursor-pointer hover:bg-red-600 dark:hover:bg-red-500 font-medium">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { openModal, closeModal, getErrorMessage } from '/static/js/utils.js';

    // Edit modal
    document.getElementById('edit-post-btn').onclick = () => openModal('edit-post-modal');
    document.getElementById('edit-post-modal-backdrop').onclick = () => closeModal('edit-post-modal');
    document.getElementById('edit-post-modal-card').onclick = (e) => e.stopPropagation();
    document.getElementById('edit-post-modal-cancel').onclick = () => closeModal('edit-post-modal');

    document.getElementById('edit-post-form').onsubmit = async (e) => {
      e.preventDefault();
      const errorEl = document.querySelector('#edit-post-modal [data-error]');
      const title = document.getElementById('edit-post-title').value.trim();
      const content = document.getElementById('edit-post-content').value.trim();
      if (!title || !content) {
        errorEl.textContent = 'All fields are required.';
        errorEl.classList.remove('hidden');
        return;
      }
      try {
        const res = await fetch('/api/posts/{{ post.id }}', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content })
        });
        if (!res.ok) {
          const data = await res.json();
          errorEl.textContent = getErrorMessage(data.detail);
          errorEl.classList.remove('hidden');
          return;
        }
        closeModal('edit-post-modal');
        window.location.reload();
      } catch {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    };

    // Delete modal
    document.getElementById('delete-post-btn').onclick = () => openModal('delete-post-modal');
    document.getElementById('delete-post-modal-backdrop').onclick = () => closeModal('delete-post-modal');
    document.getElementById('delete-post-modal-card').onclick = (e) => e.stopPropagation();
    document.getElementById('delete-post-modal-cancel').onclick = () => closeModal('delete-post-modal');

    document.getElementById('delete-post-confirm').onclick = async () => {
      const errorEl = document.querySelector('#delete-post-modal [data-error]');
      try {
        const res = await fetch('/api/posts/{{ post.id }}', {
          method: 'DELETE'
        });
        if (!res.ok) {
          const data = await res.json();
          errorEl.textContent = getErrorMessage(data.detail);
          errorEl.classList.remove('hidden');
          return;
        }
        window.location.href = '/posts';
      } catch {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    };
  </script>
{% endblock content%}
